<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Stocks Tracker</title>

<!--  idb (IIFE build – exposes global `idb`)  -->
<script src="https://cdn.jsdelivr.net/npm/idb@7/build/iife/index-min.js"></script>

<style>
  /* ───── styles (unchanged) ───── */
  :root{--primary:#0a84ff;--primary-dark:#006fe0;--success:#28a745;--success-dark:#218838;--danger:#ff3b30;--danger-dark:#d12c21;--bg:#f5f7fa;--text:#1d1d1f;--card:#ffffff;--border:#e0e0e0;--radius:12px;--shadow:rgba(0,0,0,.06);--font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:var(--font);background:var(--bg);color:var(--text)}
  input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
  .container{max-width:1000px;margin:2rem auto;padding:1rem}
  h1,h2{text-align:center;font-weight:600;margin-bottom:1rem}
  .card{background:var(--card);border-radius:var(--radius);padding:1.5rem;box-shadow:0 4px 12px var(--shadow);margin-bottom:2rem}
  input,select{padding:10px;font-size:1rem;border:1px solid var(--border);border-radius:8px;outline:none;background:#fff;width:100%}
  button{padding:10px 24px;font-size:1rem;border:none;border-radius:8px;cursor:pointer;background:var(--primary);color:#fff;transition:background .2s;width:auto}
  button:hover{background:var(--primary-dark)}.danger{background:var(--danger)}.danger:hover{background:var(--danger-dark)}.success{background:var(--success)}.success:hover{background:var(--success-dark)}.hidden{display:none !important}
  @keyframes shake{0%,100%{transform:translateX(0)}25%,75%{transform:translateX(-4px)}50%{transform:translateX(4px)}}.shake{animation:shake .3s}
  .grid{display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1rem}.grow{flex:1 1 260px;max-width:260px}.inline-btn{flex:0 0 150px}.input-wrapper{position:relative;flex:1 1 260px;max-width:260px}.input-wrapper input{padding-left:1rem;padding-right:2.8rem}.input-wrapper span{position:absolute;top:50%;transform:translateY(-50%);font-weight:600;color:#555;font-size:.9rem;pointer-events:none}.suffix{right:.6rem}.fee-plus{font-weight:700;font-size:1.2rem;margin:0 .25rem;align-self:center}
  .stock-list{display:flex;flex-wrap:wrap;gap:.5rem}.stock-item{padding:10px 16px;border:1px solid var(--border);border-radius:8px;background:#f1f3f5;cursor:pointer;transition:background .2s}.stock-item:hover{background:var(--primary);color:#fff}.stock-item.active{background:var(--primary)!important;color:#fff}
  .market-info{margin:.5rem 0 1rem;font-size:.9rem;font-weight:500}.table-wrap{width:100%;overflow-x:auto}table{width:100%;min-width:600px;border-collapse:collapse}th,td{padding:12px;border-bottom:1px solid var(--border);text-align:center;font-size:.95rem;white-space:nowrap}
  .summary{background:#f0f8ff;padding:1rem;border-radius:var(--radius);margin-top:1.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem}.summary p{margin:0}.profit-row{display:grid;gap:1rem;grid-template-columns:minmax(200px,1fr) auto;align-items:center}
  .profit-row p{margin:0;white-space:nowrap}.profit-colored{font-weight:700}.green{color:var(--success)}.red{color:var(--danger)}
  .actions{margin-top:1.5rem;display:flex;justify-content:center;gap:1rem;flex-wrap:wrap}
  .toast{position:fixed;top:20px;right:20px;background:var(--danger);color:#fff;padding:12px 20px;border-radius:6px;font-size:.95rem;box-shadow:0 2px 10px rgba(0,0,0,.2);opacity:0;transform:translateY(-10px);transition:all .3s;z-index:1000}.toast.success{background:var(--success)}.toast.show{opacity:1;transform:translateY(0)}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:9999}.modal-content{background:#fff;padding:2rem;border-radius:10px;text-align:center;max-width:350px;width:90%}.modal-buttons{display:flex;gap:1rem;margin-top:1rem}.modal-buttons button{flex:1}
  @media(max-width:767px){.grid{flex-direction:column}.grow,.input-wrapper,.inline-btn{flex:1 1 100%;max-width:100%}button{width:100%}th,td{padding:8px;font-size:.85rem}.profit-row{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="toast" id="toast"></div>

<!-- modal -->
<div class="modal" id="confirmModal">
  <div class="modal-content">
    <h3 id="confirmText"></h3>
    <div class="modal-buttons">
      <button class="success" id="confirmYes">Yes</button>
      <button class="danger" onclick="closeModal()">No</button>
    </div>
  </div>
</div>

<!-- main UI -->
<div class="container">
  <h1>myStocks</h1>
  <!-- Add Stock -->
  <div class="card">
    <h2>Add New Stock</h2>
    <div class="grid">
      <input class="grow" type="text" id="stockName" placeholder="Stock Name"/>
      <select class="grow" id="stockMarket" onchange="handleMarketSelect()"><option value="">-- Select Market --</option></select>
      <button id="saveStockBtn" class="inline-btn" onclick="addStock()">Save Stock</button>
    </div>
    <div class="market-config grid" id="customMarketForm" style="display:none;">
      <input class="grow" type="text" id="customMarketName" placeholder="Custom Market Name"/>
      <div class="input-wrapper"><input type="number" id="customMarketPercent" placeholder="Percent Fee" step="0.0001"/><span class="suffix">%</span></div>
      <span class="fee-plus">+</span>
      <div class="input-wrapper"><input type="number" id="customMarketFlat" placeholder="Flat Fee" step="0.01"/><span class="suffix">AED</span></div>
      <button class="inline-btn" onclick="addCustomMarket()">Add Market</button>
    </div>
  </div>

  <!-- Stock list -->
  <div class="card">
    <h2>My Stocks</h2>
    <p id="totalStanding" style="text-align:center;font-weight:600;margin-bottom:1rem;">Total Standing: AED 0.00</p>
    <div class="stock-list" id="stockList"></div>
  </div>

  <!-- Stock section -->
  <div class="card" id="stockSection" style="display:none;">
    <h2 id="selectedStockHeader"></h2>
    <div class="market-info" id="marketInfo"></div>
    <div class="grid" id="tradeGrid">
      <div class="input-wrapper"><input type="number" id="amount" placeholder="Amount" step="0.01"/><span class="suffix">AED</span></div>
      <div class="input-wrapper"><input type="number" id="price" placeholder="Price per Share" step="0.01"/><span class="suffix">AED</span></div>
      <button class="inline-btn" onclick="addPurchase()">Add Purchase</button>
    </div>
    <div class="table-wrap"><table id="purchaseTable"><thead><tr><th>#</th><th>Date</th><th>Amount</th><th>Price</th><th>Shares</th><th>Fee</th><th>Total</th></tr></thead><tbody></tbody></table></div>
    <div class="summary">
      <p><strong>Total Shares:</strong> <span id="totalShares">0.00</span></p>
      <p><strong>Total Invested:</strong> AED <span id="totalInvested">0.00</span></p>
      <p><strong>Average Cost/Share:</strong> AED <span id="avgCost">0.000</span></p>
      <div class="profit-row">
        <div class="input-wrapper"><input type="number" id="sellPrice" placeholder="Sell Price" step="0.01" oninput="calculateProfit()"><span class="suffix">AED</span></div>
        <p><strong>Estimated Profit:</strong> <span class="profit-colored" id="profit">AED 0.00</span></p>
      </div>
    </div>
    <div class="actions">
      <button class="danger" onclick="deleteLastPurchase()">Delete Last Purchase</button>
      <button class="danger" onclick="confirmAction('clear')">Clear Stock Data</button>
      <button class="danger" onclick="confirmAction('delete')">Delete Stock</button>
    </div>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const GIST_ID ='29476cf76a436f6e668577f730498980';
const PAT_P1='ghp',PAT_P2='_rpq3uDgS',PAT_P3='27Skx1LvatC',PAT_P4='IbyA8C25xDw0ZoBco';
const GIST_PAT = PAT_P1 + PAT_P2 + PAT_P3 + PAT_P4;
const FILE_NAME='myStocks.json';

/* default markets */
const defaultMarkets={DFM:{name:'DFM',rate:0.00275,flat:10.5},ADX:{name:'ADX',rate:0.0015,flat:0}};

/* state */
let markets=JSON.parse(JSON.stringify(defaultMarkets));
let stocks={};
let currentStock=null,pendingAction=null;

/* ---------- durable local store (IndexedDB) ---------- */
let dbPromise;
try{
  dbPromise=idb.openDB('myStocks-v1',1,{upgrade(db){db.createObjectStore('state');}});
}catch{dbPromise=null;}
function putLocal(data){
  if(!dbPromise) return;
  dbPromise.then(db=>db.put('state',data,'latest')).catch(()=>{});
}
function getLocal(){
  if(!dbPromise) return Promise.resolve(null);
  return dbPromise.then(db=>db.get('state','latest')).catch(()=>null);
}

/* ---------- GitHub headers ---------- */
const GH_BASE=`https://api.github.com/gists/${GIST_ID}`;
const GH_HEADERS={
  Authorization:`Bearer ${GIST_PAT}`,
  Accept:'application/vnd.github+json',
  'X-GitHub-Api-Version':'2022-11-28'
};

/* ---------- remote helpers ---------- */
async function pushRemote(state){
  try{
    await fetch(GH_BASE,{
      method:'PATCH',
      headers:{...GH_HEADERS,'Content-Type':'application/json'},
      body:JSON.stringify({files:{[FILE_NAME]:{content:JSON.stringify(state)}}})
    });
  }catch{}
}

/* ---------- debounce / dirty‑flag ---------- */
let dirty=false,saveTimer=null;
function queueRemotePush(){
  dirty=true;
  clearTimeout(saveTimer);
  saveTimer=setTimeout(async()=>{
    if(dirty){
      await pushRemote({stocks,markets});
      dirty=false;
    }
  },1500);
}

/* ---------- utils ---------- */
const normalizeTxt=t=>t.toLowerCase().replace(/\s+/g,'');
const getBase=n=>n.split(' [')[0];
const pct=r=>{const p=r*100;return p%1===0?p.toFixed(0):p.toFixed(3).replace(/\.?0+$/,'');};
const toast=(m,t='danger')=>{const e=document.getElementById('toast');e.className=`toast show ${t}`;e.textContent=m;setTimeout(()=>e.className='toast',2000);}
const now=()=>new Date().toLocaleDateString('en-GB')+' at '+new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
const saveBtn=document.getElementById('saveStockBtn');

/* ---------- market ui ---------- */
function populateMarkets(){
  const sel=document.getElementById('stockMarket');
  sel.innerHTML='<option value="">-- Select Market --</option>';
  Object.keys(markets).forEach(k=>{const o=document.createElement('option');o.value=k;o.textContent=markets[k].name;sel.appendChild(o);});
  sel.insertAdjacentHTML('beforeend','<option value="other">Other</option>');
  handleMarketSelect();
}
function handleMarketSelect(){
  const v=document.getElementById('stockMarket').value;
  document.getElementById('customMarketForm').style.display=v==='other'?'flex':'none';
  saveBtn.classList.toggle('hidden',v==='other');
}
function addCustomMarket(){
  const nameEl=document.getElementById('customMarketName');
  const percentEl=document.getElementById('customMarketPercent');
  const flatEl=document.getElementById('customMarketFlat');

  const raw=nameEl.value.trim();if(!raw)return toast('Enter market name.');
  const key=raw.toUpperCase();if(markets[key])return toast('Market exists');
  const rate=parseFloat(percentEl.value)/100||0,flat=parseFloat(flatEl.value)||0;
  markets[key]={name:key,rate,flat};saveData();populateMarkets();
  document.getElementById('stockMarket').value=key;
  nameEl.value='';percentEl.value='';flatEl.value='';
  toast('Market added!','success');
}

/* ---------- stocks ---------- */
function ensureSuffix(k){if(k.includes(' ['))return k;const nk=`${k} [${markets[stocks[k].market].name}]`;stocks[nk]=stocks[k];delete stocks[k];if(currentStock===k)currentStock=nk;return nk;}
function removeSuffixIfSolo(norm){const rel=Object.keys(stocks).filter(x=>normalizeTxt(getBase(x))===norm);if(rel.length===1&&rel[0].includes(' [')){const old=rel[0];stocks[getBase(old)]=stocks[old];delete stocks[old];if(currentStock===old)currentStock=getBase(old);}}
function addStock(){
  const base=document.getElementById('stockName').value.trim(),mKey=document.getElementById('stockMarket').value;if(!base||!mKey)return toast('Stock name and market required.');
  const norm=normalizeTxt(base),rel=Object.keys(stocks).filter(x=>normalizeTxt(getBase(x))===norm);
  if(rel.some(x=>stocks[x].market===mKey))return toast('Stock already exists.');
  rel.forEach(ensureSuffix);const key=rel.length?`${base} [${markets[mKey].name}]`:base;
  stocks[key]={market:mKey,purchases:[]};saveData();document.getElementById('stockName').value='';document.getElementById('stockMarket').value='';handleMarketSelect();toast('Stock added!','success');loadList();
}
function loadList(){
  const list=document.getElementById('stockList');list.innerHTML='';
  Object.keys(stocks).forEach(n=>{const d=document.createElement('div');d.className='stock-item'+(n===currentStock?' active':'');d.textContent=n;d.onclick=()=>selectStock(n);list.appendChild(d);});
  updateStanding();
}
function selectStock(n){currentStock=n;const m=markets[stocks[n].market];document.getElementById('selectedStockHeader').textContent=n;document.getElementById('marketInfo').textContent=`Market: ${m.name} — Fee: ${pct(m.rate)}% + AED ${m.flat}`;document.getElementById('stockSection').style.display='block';loadList();updateUI();}

/* ---------- purchases ---------- */
function addPurchase(){
  const amt=parseFloat(document.getElementById('amount').value),price=parseFloat(document.getElementById('price').value);if(!amt||!price)return toast('Amount and Price required.');
  const m=markets[stocks[currentStock].market],fee=amt*m.rate+m.flat,total=amt+fee,shares=amt/price;stocks[currentStock].purchases.push({amount:amt,price,shares,fee,total,date:now()});saveData();['amount','price'].forEach(id=>document.getElementById(id).value='');updateUI();
}
function updateUI(){
  const tb=document.querySelector('#purchaseTable tbody');tb.innerHTML='';let shares=0,invested=0;
  stocks[currentStock]?.purchases.forEach((p,i)=>{shares+=p.shares;invested+=p.total;tb.innerHTML+=`<tr><td>${i+1}</td><td>${p.date}</td><td>AED ${p.amount.toFixed(2)}</td><td>${p.price.toFixed(2)}</td><td>${p.shares.toFixed(2)}</td><td>${p.fee.toFixed(2)}</td><td>${p.total.toFixed(2)}</td></tr>`;});
  document.getElementById('totalShares').textContent=shares.toFixed(2);document.getElementById('totalInvested').textContent=invested.toFixed(2);document.getElementById('avgCost').textContent=shares?(invested/shares).toFixed(3):'0.000';calculateProfit();updateStanding();
}
function calculateProfit(){const sell=parseFloat(document.getElementById('sellPrice').value),p=stocks[currentStock]?.purchases||[],shares=p.reduce((s,a)=>s+a.shares,0),invested=p.reduce((s,a)=>s+a.total,0),out=document.getElementById('profit');if(isNaN(sell)||!shares){out.textContent='AED 0.00';out.className='profit-colored';return;}const m=markets[stocks[currentStock].market],profit=(sell*shares-(sell*shares*m.rate+m.flat))-invested;out.textContent=`AED ${profit.toFixed(2)}`;out.className='profit-colored '+(profit>0?'green':profit<0?'red':'');}

/* ---------- total standing ---------- */
function updateStanding(){
  let total=0;
  Object.values(stocks).forEach(s=>{
    total+= (s.purchases||[]).reduce((acc,p)=>acc+p.total,0);
  });
  document.getElementById('totalStanding').textContent=`Total Standing: AED ${total.toFixed(2)}`;
}

/* ---------- delete last purchase ---------- */
function deleteLastPurchase(){
  if(!currentStock||!stocks[currentStock]||stocks[currentStock].purchases.length===0){
    return toast('No purchases to delete.');
  }
  stocks[currentStock].purchases.pop();
  saveData();
  updateUI();
  toast('Last purchase deleted!','success');
}

/* ---------- clear/delete ---------- */
function confirmAction(t){pendingAction=t;document.getElementById('confirmText').innerHTML=t==='delete'?`Are you sure you want to delete <strong>${currentStock}</strong> completely?`:`Are you sure you want to clear all data for <strong>${currentStock}</strong>?`;document.getElementById('confirmModal').style.display='flex';}
function closeModal(){document.getElementById('confirmModal').style.display='none';pendingAction=null;}
document.getElementById('confirmYes').onclick=()=>{
  if(!currentStock)return;
  const norm=normalizeTxt(getBase(currentStock));
  if(pendingAction==='delete'){
    delete stocks[currentStock];
    removeSuffixIfSolo(norm);
    currentStock=null;
    document.getElementById('stockSection').style.display='none';
    toast('Stock deleted!','success');
  }else{
    stocks[currentStock].purchases=[];
    updateUI();
    toast('Stock data cleared!','success');
  }
  saveData();loadList();closeModal();
};

/* ---------- unload fail‑safe ---------- */
window.addEventListener('pagehide',()=>{
  if(!dirty) return;
  fetch(GH_BASE,{
    method:'PATCH',
    headers:{...GH_HEADERS,'Content-Type':'application/json'},
    body:JSON.stringify({files:{[FILE_NAME]:{content:JSON.stringify({stocks,markets})}}}),
    keepalive:true
  });
});

/* ---------- init ---------- */
function applyData(d){
  markets=Object.keys(d.markets||{}).length?d.markets:JSON.parse(JSON.stringify(defaultMarkets));
  stocks=d.stocks||{};
  populateMarkets();
  loadList();
}

/*  ➜  draw the UI immediately  */
applyData({});

/*  then merge local / remote data  */
async function loadData(){
  const local=await getLocal();
  if(local&&Object.keys(local).length) applyData(local);
  fetch(GH_BASE,{headers:GH_HEADERS})
    .then(r=>r.ok?r.json():Promise.reject())
    .then(g=>{
      const raw=g?.files?.[FILE_NAME]?.content||'{}';
      let remote={};
      try{remote=JSON.parse(raw);}catch{}
      applyData(remote);
      putLocal(remote);
    })
    .catch(()=>{});
}
loadData();

/* ---------- save wrapper ---------- */
function saveData(){
  putLocal({stocks,markets});
  queueRemotePush();
}
</script>
</body>
</html>
